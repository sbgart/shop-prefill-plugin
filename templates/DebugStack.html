<div id="prefill-debug-stack" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    max-width: 500px;
    max-height: 80vh;
    background: #e3f2fd;
    border: 2px solid #2196f3;
    border-radius: 5px;
    font-family: monospace;
    z-index: 99999;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    font-size: 12px;
    display: flex;
    flex-direction: column;
    transition: all 0.2s ease;
  ">
  {* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ *}
  <div style="
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #2196f3;
      color: white;
      border-radius: 3px 3px 0 0;
      flex-shrink: 0;
    " ondblclick="PrefillDebugHelper.toggleCollapse()" title="–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è">
    <strong>üîç Debug Panel</strong>&nbsp;
    <div style="display: flex; gap: 4px">
      {* –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è *}
      <button onclick="PrefillDebugHelper.refreshDebug()" class="prefill-debug-btn" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ">üîÑ</button>

      {* –ö–Ω–æ–ø–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è *}
      <button id="prefill-debug-collapse-btn" onclick="PrefillDebugHelper.toggleCollapse()" class="prefill-debug-btn"
        title="–°–≤–µ—Ä–Ω—É—Ç—å/–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å">
        ‚ûñ
      </button>

      {* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è *}
      <button onclick="this.closest('#prefill-debug-stack').remove()" class="prefill-debug-btn" title="–ó–∞–∫—Ä—ã—Ç—å">
        ‚ùå
      </button>
    </div>
  </div>

  <style>
    .prefill-debug-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 3px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      min-width: 28px;
    }

    .prefill-debug-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .prefill-debug-btn:active {
      transform: scale(0.95);
    }
  </style>

  <div id="prefill-debug-body" style="display: flex; flex-direction: column; overflow: hidden; flex-grow: 1">
    {* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –ø–ª–∞–≥–∏–Ω–∞ *}
    <div style="
            padding: 8px 15px;
            background: {if $plugin_enabled}#d4edda{else}#f8d7da{/if};
            border-bottom: 1px solid {if $plugin_enabled}#28a745{else}#dc3545{/if};
            font-size: 10px;
            flex-shrink: 0;
        ">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px">
        <div style="display: flex; align-items: center; gap: 8px">
          <div>
            <strong>{if $plugin_enabled}‚úÖ{else}‚ö†Ô∏è{/if} –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ:</strong>
            {if $plugin_enabled}–í–ö–õ–Æ–ß–ï–ù–û{else}–í–´–ö–õ–Æ–ß–ï–ù–û{/if}
          </div>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer">
            <input type="checkbox" {if $plugin_enabled}checked{/if}
              onchange="PrefillDebugHelper.togglePrefill(this.checked)" style="cursor: pointer;">
            <span style="font-size: 9px">–í–∫–ª/–í—ã–∫–ª</span>
          </label>
        </div>

        <div style="display: flex; gap: 5px">
          {* –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è *}
          <button onclick="PrefillDebugHelper.forcePrefill()" style="
              background: #4caf50;
              color: white;
              border: none;
              border-radius: 3px;
              padding: 4px 8px;
              cursor: pointer;
              font-size: 10px;
              font-weight: bold;
            " title="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å checkout (Force Prefill)">
            ‚ö° Force
          </button>

          {* –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ *}
          <button onclick="PrefillDebugHelper.clearStorage()" style="
              background: #ff9800;
              color: white;
              border: none;
              border-radius: 3px;
              padding: 4px 8px;
              cursor: pointer;
              font-size: 10px;
              font-weight: bold;
            " title="–û—á–∏—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é checkout">
            üóëÔ∏è Clear
          </button>
        </div>
      </div>
    </div>

    {* –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ *}
    <div style="padding: 0; background: #e8f5e9; border-bottom: 1px solid #a5d6a7; flex-shrink: 0">
      <details open>
        <summary style="
            padding: 8px 15px;
            cursor: pointer;
            color: #2e7d32;
            font-weight: bold;
            font-size: 10px;
            user-select: none;
            outline: none;
          ">
          üíæ –ê–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (Session Storage)
        </summary>
        <div style="padding: 0 15px 15px 15px">
          {if empty($current_storage)}
          <p style="
              color: #ff5722;
              font-weight: bold;
              font-size: 10px;
              margin: 0;
              padding: 10px;
              background: #fff;
              border: 1px solid #ffcdd2;
              border-radius: 4px;
            ">
            ‚ùå –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø—É—Å—Ç–æ–µ
          </p>
          {else} {assign var="has_order" value=isset($current_storage.order)} {assign var="has_auth"
          value=isset($current_storage.order.auth)} {assign var="has_auth_data"
          value=isset($current_storage.order.auth.data)} {assign var="has_region"
          value=isset($current_storage.order.region)} {assign var="has_shipping"
          value=isset($current_storage.order.shipping)} {assign var="has_details"
          value=isset($current_storage['details-section'])} {assign var="has_payment"
          value=isset($current_storage['payment-section'])} {assign var="has_confirm"
          value=isset($current_storage['confirm-section'])}

          <div style="
              background: #fff;
              padding: 10px;
              border: 1px solid #a5d6a7;
              border-radius: 4px;
              margin-bottom: 10px;
              font-size: 10px;
              line-height: 1.6;
            ">
            <strong style="color: #2e7d32">üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:</strong><br />
            order: {if $has_order}‚úÖ{else}‚ùå{/if}<br />
            {if $has_order} ‚îî‚îÄ auth: {if $has_auth}‚úÖ{else}‚ùå{/if} {if $has_auth} ‚Üí data: {if
            $has_auth_data}‚úÖ{else}‚ùå{/if}{/if}<br />
            ‚îî‚îÄ region: {if $has_region}‚úÖ{else}‚ùå{/if}<br />
            ‚îî‚îÄ shipping: {if $has_shipping}‚úÖ{else}‚ùå{/if}<br />
            {/if} ‚îî‚îÄ details: {if $has_details}‚úÖ{else}‚ùå{/if}<br />
            ‚îî‚îÄ payment: {if $has_payment}‚úÖ{else}‚ùå{/if}<br />
            ‚îî‚îÄ confirm: {if $has_confirm}‚úÖ{else}‚ùå{/if}
          </div>

          <pre style="
              margin: 0;
              padding: 10px;
              background: #fff;
              border: 1px solid #a5d6a7;
              border-radius: 4px;
              font-size: 9px;
              max-height: 200px;
              overflow: auto;
            ">
  {$current_storage|@print_r}</pre>
          {/if}
        </div>
      </details>
    </div>

    {* –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è *}
    <div style="padding: 0; background: #e1f5fe; border-bottom: 1px solid #b3e5fc; flex-shrink: 0">
      <details>
        <summary style="
            padding: 8px 15px;
            cursor: pointer;
            color: #0277bd;
            font-weight: bold;
            font-size: 10px;
            user-select: none;
            outline: none;
          ">
          üì¶ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è (shopPrefillPluginFillParams)
        </summary>
        <div style="padding: 0 15px 15px 15px">
          {* –ú–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è *}
          <div style="
              background: #fff3e0;
              padding: 8px;
              border: 1px solid #ffb74d;
              border-radius: 4px;
              margin-bottom: 10px;
              font-size: 9px;
            ">
            <strong>‚ÑπÔ∏è –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:</strong><br />
            ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {if $fill_params_meta.user_authorized}‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (ID:
            {$fill_params_meta.user_id}){else}‚ùå –ì–æ—Å—Ç—å{if $fill_params_meta.guest_hash} (hash:
            {$fill_params_meta.guest_hash|escape}){/if}{/if}<br />
            ‚Ä¢ –ó–∞–∫–∞–∑–æ–≤: {$fill_params_meta.orders_count}<br />
            ‚Ä¢ –ò—Å—Ç–æ—á–Ω–∏–∫: {$fill_params_meta.source|escape}
          </div>

          <pre style="
              margin: 0;
              padding: 10px;
              background: #fff;
              border: 1px solid #b3e5fc;
              border-radius: 4px;
              font-size: 9px;
              max-height: 150px;
              overflow: auto;
            ">
{$fill_params|@print_r}</pre>
        </div>
      </details>
    </div>

    {* –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π *}
    <div style="padding: 15px; overflow-y: auto; flex-grow: 1">
      {foreach $debug_stack as $hook_name => $entries}
      <div style="
          background: #fff;
          border: 2px solid #2196f3;
          border-radius: 6px;
          margin-bottom: 15px;
          overflow: hidden;
          flex-shrink: 0;
        ">
        {* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ö—É–∫–∞ *}
        <div style="
            background: #e3f2fd;
            padding: 5px 10px;
            border-bottom: 1px solid #2196f3;
            font-weight: bold;
            color: #1976d2;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
          ">
          <span>üìç {$hook_name|escape}</span>
          <span style="font-size: 9px; opacity: 0.7">{$entries|count} entries</span>
        </div>

        <div style="padding: 10px">
          {foreach $entries as $entry}
          <div style="
                background: #fcfcfc;
                padding: 8px;
                border-radius: 4px;
                margin-bottom: {if !$entry@last}10px{else}0{/if};
                border-left: 4px solid {$entry.color};
              ">
            <div style="font-weight: bold; color: {$entry.color}; margin-bottom: 5px; font-size: 10px">
              {$entry.title|escape}
            </div>

            {if empty($entry.data)}
            <p style="color: #ff5722; font-weight: bold; font-size: 10px; margin: 0">‚ùå –•—Ä–∞–Ω–∏–ª–∏—â–µ –ü–£–°–¢–û–ï</p>
            {else} {assign var="has_order" value=isset($entry.data.order)} {assign var="has_auth"
            value=isset($entry.data.order.auth)} {assign var="has_auth_data" value=isset($entry.data.order.auth.data)}
            {assign var="has_region" value=isset($entry.data.order.region)} {assign var="has_shipping"
            value=isset($entry.data.order.shipping)} {assign var="has_details"
            value=isset($entry.data['details-section'])} {assign var="has_payment"
            value=isset($entry.data['payment-section'])} {assign var="has_confirm"
            value=isset($entry.data['confirm-section'])}

            <div style="font-size: 10px; line-height: 1.4">
              order: {if $has_order}‚úÖ{else}‚ùå{/if}<br />
              {if $has_order} ‚îî‚îÄ auth: {if $has_auth}‚úÖ{else}‚ùå{/if} {if $has_auth} ‚Üí data: {if
              $has_auth_data}‚úÖ{else}‚ùå {/if} {/if}<br />
              ‚îî‚îÄ region: {if $has_region}‚úÖ{else}‚ùå{/if}<br />
              ‚îî‚îÄ shipping: {if $has_shipping}‚úÖ{else}‚ùå{/if}<br />
              {/if} ‚îî‚îÄ details: {if $has_details}‚úÖ{else}‚ùå{/if}<br />
              ‚îî‚îÄ payment: {if $has_payment}‚úÖ{else}‚ùå{/if}<br />
              ‚îî‚îÄ confirm: {if $has_confirm}‚úÖ{else}‚ùå{/if}<br />
            </div>

            <details style="margin-top: 5px">
              <summary style="cursor: pointer; color: #1976d2; font-size: 9px; user-select: none">üìã –î–∞–º–ø</summary>
              <pre style="
                  margin: 5px 0 0 0;
                  padding: 5px;
                  background: #f5f5f5;
                  border: 1px solid #ddd;
                  border-radius: 3px;
                  overflow: auto;
                  max-height: 150px;
                  font-size: 9px;
                  line-height: 1.2;
                ">
                  {$entry.data|@print_r}</pre>
            </details>
            {/if}
          </div>
          {/foreach}
        </div>
      </div>
      {/foreach}
    </div>
  </div>
</div>