# Концепция плагина Prefill

- Плагин предзаполняет поля на основе прошлого заказа.
- Скрывает то множество полей в корзине для заполнения и выдает краткую выжимку, это реализуемо так как все поля изначально предзаполнены.
  - **Проблема:** Если скрыть поля с незаполненными обязательными полями, пользователь не сможет их заполнить
  - **Решение:** См. [VALIDATION.md](VALIDATION.md) - как проверять ошибки перед скрытием полей
- Позволяет выбрать другие свои адреса на основе прошлых заказов.

## Секции корзины (DOM-структура)

В корзине Shop-Script на странице оформления заказа (`/order/`) присутствуют следующие секции, с которыми работает плагин Prefill:

- **`wa-step-auth-section`** — секция авторизации/покупателя (ФИО, email, телефон)
- **`wa-step-region-section`** — секция выбора региона/страны
- **`wa-step-shipping-section`** — секция выбора способа доставки и адреса
- **`wa-step-details-section`** — секция дополнительных данных (может содержать кастомные поля)
- **`wa-step-payment-section`** — секция выбора способа оплаты (может содержать кастомные поля плагинов оплаты)
- **`wa-step-confirm-section`** — секция подтверждения заказа и комментария

Эти классы используются для:

- Идентификации секций в JavaScript для предзаполнения
- Скрытия/показа секций в зависимости от настроек плагина
- Валидации заполненности обязательных полей перед скрытием

### Настройки предзаполнения секций

Администратор может включать/выключать предзаполнение для каждой секции через настройки:

```
prefill/sections/auth     — секция покупателя
prefill/sections/region   — секция региона
prefill/sections/shipping — секция доставки
prefill/sections/details  — секция адреса (улица)
prefill/sections/payment  — секция оплаты
prefill/sections/confirm  — секция подтверждения (комментарий)
```

**Положительная логика:** `true` = предзаполнять, `false` = не предзаполнять. По умолчанию все секции включены.

**Проверка заполненности секций:**

Перед предзаполнением плагин проверяет, не заполнена ли секция уже (например, CitySelect мог заполнить регион). Проверяются ключевые поля:

| Секция | Ключевые поля | Описание |
|--------|---------------|----------|
| auth | data.email, data.phone, data.firstname | Любое контактное данное |
| region | city | Город |
| shipping | type_id | Выбран способ доставки |
| details | shipping_address.street | Адрес улицы |
| payment | id | Выбран способ оплаты |
| confirm | comment | Комментарий к заказу |

## Примеры корзин (ссылки)

- https://gangga.ru/order/
  - тут есть плагин перезвонить, BNP, а так все стандартно
- https://kresla-e.ru/order/
  - Классическая корзина, есть выбор типа покупателя, юр или физик.
  - Есть галочка согласия на обработку перс данных
- https://teyes.com.ru/order/
  - Тут применяется плагин BNP, можно посмотреть структуру.

## Логика и идеи

- Надо продумать как будет запоминаться тип покупателя - персона или компания
- У оплаты есть свои поля еще кастомные, они заполняются сами с профиля, если там они заполнены. Но наш плагин их не перебьет если пользователь ввел отличные от профиля данные, все время будут подставляться данные с профиля.
  - Данную проблему надо изучить, возможно можно отловить привязки и обновлять профиль?
  - Вот промт "В некоторых плагинах оплаты есть привязка к полям профиля, и интересно то что сам вебасист эти поля не обновляет с оформленного заказа, но ведь пользователь их указал. Я бы хотел предложить админу сайта опцию сохранять такие поля но нам надо понять поймем ли мы что такие поля привязаны к профилю пользователя ? дСейчас я говорю о плагине оплаты invoicejur, там привязываются payment[settings][cust_inn] и payment[settings][cust_company], а привязку нам надо понять из хуков корзины, в которых мы будем вести работу ну либо при хуке оформления заказа. Давай покопаемся в коде и поймем реально ли привязки отловить"
- В вариантах одной доставки может быть запрошены поля. Допустим тут для почты запрашивается адрес https://medmag24.ru/order/
- ✅ **Реализовано:** Галочка согласия для гостей на сохранение данных. Администратор может включить/выключить через настройку `guest/consent_required`. См. раздел [Согласие гостя на сохранение данных](#согласие-гостя-на-сохранение-данных-prefill_consent) и [guest-consent-required.md](../implemented/guest-consent-required.md)
  - Старая идея: ~~Некоторые еще ставят галочку для соглашения с условиями предоставления услуг - может сделать опцию что бы оно проставлялось если ранее уже ставил?~~
- Наверное стоит сделать прям шаблон в который будут вставляться переменные для формирования коротких сообщений о выбранном способе доставки. И такой шаблон для секции Покупатель и секции Доставка.
- Если отключен выбранный пользователем способ доставки то в целом ничего не произойдет но надо его исключать из предлагаемых.
- Увидел очень много кто купил плагин "Вам перезвонить?", видимо тоже надо будет предзаполнять. Прим. https://gangga.ru/order/
- Сразу добавить функцию которая будет способы оплаты отображать горизонтально, может даже со свайпами.
- Часто вижу что предупреждение к доставке прям выделяют, наверное стоит дать пользователю возможность выводить его при скрытии полей.
- Бывает когда люди сами отключают некоторые секции, они обычно больше заголовка ничего не содержат.
- Плагин Citiselect при выборе города или автоматическом определении предзаполняе секцию региона в хранилище, после создает куки со всеми этими данными и видимо на этом основывается как первоисточник данных.
- Shop-Script сам предзаполняет регион который ранее был выбран пользователем для авторизованного пользователя.

## Что надо проверить

- [ ] Проверить после создания заказа: пользователь должен быть авторизован или нет?
  - При опции "создавать нового пользователя" юзер не авторизуется.
  - Надо проверить авторизуется ли пользователь после оформления заказа при опции "подтверждать пользователя" - тут конечно если пользователь уже был
    - Если нет то можно добавить эту опцию, что бы пользователь после подтверждения был автоматом авторизован.
- [ ] Проверить работу плагина в минимальной корзине, когда есть выбор из нескольких регионов
- [x] Проверить работу плагина при добавлении всех полей и даже кастомных (оказывается есть радио выбор)
  - Добавил радио выбор и плагин сохранил выбор.
- [x] У каждого типа оплаты может быть подтип выбора из списка - та же яндекс касса, надо проверить как оно сохраняется.
  - Проверил, работает!
- [ ] Плагин BNP который позволяет делать несколько видов доставок - надо приобрести и потестировать
- [ ] Интересно, зашел без авторизации, заказ сделал, после чего снова закинул товар в корзину, зашел а все поля кроме фио заполнены - надо проверить наш ли плагин это делает. Если да то это в целом круто но можно еще фио подставлять но это уже может быть запрещено законом, хотя мы все равно уже собрали их при заказе.

## Баги

- Будто бы пропадает раздел комментария после предзаполнения

## Механизм хранения данных

### Временное хранилище (checkout_params)

Shop-Script использует **двухуровневую систему** хранения данных корзины:

#### 1. PHP-сессия (основное хранилище)

- **Где:** Сервер (`wa()->getStorage()->set('shop/checkout')` → `$_SESSION`)
- **Что:** Текущий ввод пользователя в корзине
- **Когда используется:** Пока PHP-сессия активна
- **Жизненный цикл:** До истечения сессии или оформления заказа

#### 2. LocalStorage (резервное хранилище)

- **Где:** Браузер (`localStorage.setItem('webasyst/shop/order/form')`)
- **Что:** Копия данных формы корзины
- **Когда используется:** Когда PHP-сессия истекла (`$session_is_alive = false`)
- **Назначение:** Восстановление формы после истечения PHP-сессии
- **Автосохранение:** При каждом `update()` формы, но только если форма заполнена без предупреждений. Пока есть ошибки валидации, данные хранятся только в PHP-сессии.
- **Автозагрузка:** При инициализации checkout, если сессия мертва

#### Логика работы:

```
┌─ Сессия жива? ──┐
│   ДА            │   НЕТ
│   ↓             │   ↓
│ PHP-сессия      │ LocalStorage → восстановление → новая PHP-сессия
│ (основа)        │ (backup)
└─────────────────┘
```

#### Очистка хранилищ:

- **PHP:** `wa()->getStorage()->remove('shop/checkout')` при оформлении заказа
- **JS:** `localStorage.removeItem('webasyst/shop/order/form')` при оформлении заказа
- **Обе:** Очищаются одновременно в `shopFrontendOrderActions::processCreate()`

### Куки стороннего плагина "Cityselect"

- **Где:** Браузер (куки)
- **Что:** Выбранный/определенный город и регион
- **Срок жизни:** 1 год
- **Особенность:** Cityselect предзаполняет секцию Регион только один раз при первом заходе (пока куки не истекут). После оформления заказа повторно НЕ заполняет секцию Регион, даже если хранилище очищено.

### Хеш гостя в заказах (prefill_guest_hash)

- **Где:** Cookie `prefill_guest_hash` + `shop_order_params` (БД)
- **Что:** Уникальный идентификатор гостя для привязки заказов
- **Срок жизни cookie:** 1 год (автоматически продлевается при каждом визите)
- **Безопасность:** HTTP-only cookie, SHA256 хеш, невозможно подделать

#### Механизм работы:

1. **Первый визит** → генерируется `guest_<uniqid>_<microtime>` → хешируется SHA256 → сохраняется в HTTP-only cookie
2. **Оформление заказа** → хеш сохраняется в `shop_order_params` (`name='prefill_guest_hash'`)
3. **Повторный визит** → хеш читается из cookie → **автоматически продлевается на 1 год** → ищем последний заказ с этим хешем в БД → предзаполняем

**Автопродление cookie:** Cookie хеша гостя автоматически продлевается при **каждом** заходе на сайт благодаря хуку `frontendHead`, который срабатывает на всех страницах магазина. Это гарантирует, что cookie не истечет, пока пользователь периодически посещает сайт.

#### Преимущества:

- **Всегда актуальные данные:** Берутся из БД
- **Менеджер исправил заказ** → изменения сразу применяются при предзаполнении
- **Можно показать список адресов:** Все заказы гостя найдутся по одному хешу
- **Безопасность:** HTTP-only cookie защищает от XSS атак

### Постоянное хранилище

- **Где:** База данных Shop-Script
- **Что:** Профиль контакта (для авторизованных) + история заказов (для всех)
- **Когда очищается:** Не очищается автоматически

---

## Приоритеты источников данных

### Для неавторизованных пользователей (гостей)

| Приоритет | Источник                                | Применение                                                                    |
| --------- | --------------------------------------- | ----------------------------------------------------------------------------- |
| 1         | Ручной ввод (checkout_params)           | Не перезаписываем то, что пользователь ввел                                   |
| 2         | Куки Cityselect (только секция Регион)  | Если активен, есть куки, и секция Регион не заполнена                         |
| 3         | Последний заказ по `prefill_guest_hash` | Находим заказ в БД по хешу из куки, предзаполняем все секции                  |
| -         | **Согласие (prefill_consent)**          | **Влияет на сохранение:** если согласие не дано — `guest_hash` не сохраняется |

> **Важно:** Если `guest/consent_required = true` и гость не поставил галочку согласия, хеш НЕ сохраняется в заказ, и предзаполнение при следующем визите невозможно.

### Для авторизованных пользователей

| Приоритет | Источник                               | Применение                                         |
| --------- | -------------------------------------- | -------------------------------------------------- |
| 1         | Ручной ввод (checkout_params)          | Не перезаписываем то, что пользователь ввел        |
| 2         | Профиль контакта Shop-Script           | Автоматическое предзаполнение системой             |
| 3         | Куки Cityselect (только секция Регион) | Может переопределить секцию Регион из профиля      |
| 4         | Последний заказ по `contact_id`        | Данные из БД: способ доставки/оплаты, альт. адреса |

---

## Сценарии

### Не авторизованный пользователь

#### Первый визит

- Пользователь впервые попал на сайт
  - **Cityselect:** Определил город, заполнил секцию Регион, сохранил в куки (1 год)
  - **Prefill:** Генерирует куку для идентификации пользователя (на 1 год), но ничего не заполняет

#### Повторный визит (без заказов, в пределах 1 года)

- Пользователь зашел на сайт снова
  - **Cityselect:** НЕ заполняет секцию Регион (куки еще действуют, уже заполнял ранее)
  - **Prefill:** Ищет последний заказ по `prefill_guest_hash`:
    - Если заказы найдены → предзаполняет данные из последнего заказа
    - Если заказов нет → ничего не делает (только продлевает куку)

#### Брошенная корзина (незавершенное оформление)

**Сценарий 1: Вернулся пока сессия жива**

- Пользователь зашел в корзину, частично заполнил данные, закрыл вкладку
- Вернулся позже (в течение ~24 минут, сессия жива)
  - **PHP-сессия:** Данные сохранились в `shop/checkout`
  - **LocalStorage:** Копия также сохранена (на всякий случай)
  - **Prefill:** Не нужно ничего делать — данные уже в хранилище
  - **Результат:** Форма восстанавливается из PHP-сессии

**Сценарий 2: Вернулся после истечения сессии (данные сохранились в LocalStorage)**

- Пользователь зашел в корзину, корректно заполнил все обязательные поля без ошибок валидации, закрыл браузер
- Вернулся позже (через несколько часов, сессия умерла)
  - **PHP-сессия:** Очищена автоматически (истекла по таймауту)
  - **LocalStorage:** Данные сохранились (форма была заполнена без ошибок валидации)
  - **Shop-Script:** Автоматически восстанавливает форму из localStorage
  - **Prefill:** Не нужно ничего делать — Shop-Script сам восстановил. Каждый раз продлевает эту куку.
  - **Результат:** Форма восстанавливается из localStorage браузера

**Сценарий 3: Вернулся после истечения сессии (данные НЕ сохранились в LocalStorage)**

- Пользователь зашел в корзину, частично заполнил данные с ошибками валидации, закрыл браузер
- Вернулся позже (через несколько часов, сессия умерла)
  - **PHP-сессия:** Очищена автоматически (истекла по таймауту)
  - **LocalStorage:** Данные НЕ сохранились (были ошибки валидации при заполнении)
  - **Shop-Script:** Нечего восстанавливать из localStorage
  - **Prefill:** Ищет последний заказ по `prefill_guest_hash`:
    - Если заказы найдены → предзаполняет данные из последнего заказа
    - Если заказов нет → ничего не делает (только продлевает куку)
  - **Cityselect:** НЕ заполнит секцию Регион повторно (заполняет только при первом заходе на сайт)
  - **Результат:** Форма показывает данные из прошлых заказов ИЛИ пустую форму (если заказов по хешу нет)

#### После оформления заказа

**Сценарий 1: Гость дал согласие (`guest/consent_required = true` и галочка поставлена) ИЛИ согласие не требуется по указанию администратора (`guest/consent_required = false`)**

- Пользователь оформил заказ (не авторизуясь), затем снова зашел в корзину
  - **Хранилище:** Очищено автоматически Shop-Script после оформления заказа
  - **Cityselect:** НЕ заполняет секцию Регион повторно (куки еще действуют, логика плагина)
  - **Prefill:** Cookie `prefill_consent=1` установлена (или согласие не требуется)
  - **Prefill:** Хеш гостя **сохранен** в заказе (`shop_order_params`)
  - **Prefill:** Предзаполняет из БД (данные последнего заказа с этим хешем)
    - Заполняем секции в соответствии с правами доступа (проверяется специальной функцией):
      - Учитываются настройки администратора (`prefill.sections.*` для секций)
      - Учитывается наличие данных в полях (не перезаписываем ручной ввод)
      - Заполняются разрешенные секции: покупатель, регион, доставка, оплата, комментарий

**Сценарий 2: Гость НЕ дал согласие (`guest/consent_required = true` и галочка НЕ поставлена)**

##### Сценарий 2.1: Гость ранее заказывал (кука с хешем существует)

- Пользователь оформил заказ, НЕ поставив галочку согласия, затем снова зашел в корзину
  - **Хранилище:** Очищено автоматически Shop-Script после оформления заказа
  - **Cityselect:** НЕ заполняет секцию Регион повторно (куки действуют, заполняет только если истекли)
  - **Prefill:** Cookie `prefill_consent` отсутствует
  - **Prefill:** Хеш гостя **НЕ сохранен** в новом заказе (согласие не дано)
  - **Prefill:** Ищет данные из **прошлых заказов** по хешу из куки
  - **Результат:** Предзаполнение работает из данных предыдущих заказов

##### Сценарий 2.2: Гость заказывает впервые (или куки истекли)

- Пользователь впервые зашел на сайт или куки истекли
  - **Хранилище:** Пустое (Shop-Script очищает после заказа)
  - **Cityselect:** Заполняет секцию Регион (куки истекли или отсутствуют)
  - **Prefill:** Cookie `prefill_consent` отсутствует
  - **Prefill:** Хеш гостя генерируется, но НЕ сохраняется в заказе
  - **Prefill:** Предзаполнение **невозможно** (нет прошлых заказов)
  - **Результат:** Пользователь видит пустую форму

#### После истечения куков Cityselect (через 1+ год)

- Пользователь зашел на сайт спустя год
  - **Cityselect:** Снова определяет город, заполняет секцию Регион, обновляет куки
  - **Prefill:** Cookie `prefill_guest_hash` автоматически продлевается при каждом визите
  - **Prefill:** Находит последний заказ по хешу → предзаполняет остальные секции

#### Взаимодействие с ручным вводом

- **Пользователь изменил данные вручную после предзаполнения:**
  - **Решение:** Не перезаписываем (проверяем наличие данных в `checkout_params` перед заполнением)
  - При оформлении заказа — новые данные сохраняются в БД и будут использоваться при следующем визите

### Согласие гостя на сохранение данных (prefill_consent)

- **Где:** Cookie `prefill_consent`
- **Что:** Согласие гостя на сохранение данных для предзаполнения
- **Срок жизни:** 1 год (автоматически продлевается при каждом визите)
- **Безопасность:** HTTP-only cookie для защиты от XSS
- **Значения:** `'1'` = согласие дано, отсутствие куки = нет согласия

**Автопродление cookie:** Cookie согласия автоматически продлевается при каждом заходе на сайт благодаря хуку `frontendHead`. Метод `hasConsent()` проверяет наличие cookie и при необходимости продлевает её на 1 год.

#### Механизм работы:

**Когда `guest/consent_required = true` (по умолчанию):**

1. **Отображение:** Гость видит галочку "Запомнить мои данные для следующего заказа" на странице оформления заказа
2. **Галочка НЕ поставлена** → cookie не устанавливается → `guest_hash` **НЕ сохраняется** в заказ → данные **НЕ предзаполнятся** при следующем визите
3. **Галочка поставлена** → cookie `prefill_consent=1` устанавливается → `guest_hash` **сохраняется** в заказ → данные **предзаполнятся** при следующем визите

**Когда `guest/consent_required = false`:**

- Галочка **НЕ отображается**
- `guest_hash` **всегда сохраняется** автоматически (как будто согласие есть всегда)
- Данные **всегда предзаполняются** без запроса согласия

#### Преимущества:

- **Соответствие GDPR:** Пользователь контролирует сохранение своих данных (когда требование включено)
- **Гибкость:** Администратор может включить/выключить запрос согласия через настройки
- **Безопасность:** HTTP-only cookie защищает от XSS атак

#### Связь с guest_hash:

- Согласие влияет **только на неавторизованных** пользователей
- Если согласие **не дано** → хеш гостя НЕ сохраняется → предзаполнение невозможно
- Если согласие **дано** или **не требуется** → хеш сохраняется → предзаполнение работает

> **Подробнее:** См. [guest-consent-required.md](../implemented/guest-consent-required.md) для детальной логики работы настройки

---

### Авторизованный пользователь

#### Первый заход в корзину

- Пользователь авторизован, заходит в корзину
  - **Shop-Script:** Автоматически заполняет поля из профиля контакта (базовое поведение)
  - **Cityselect:** Может переопределить секцию Регион (если активен и отличается от профиля)
  - **Prefill:** НЕ предзаполняет (данные уже есть из профиля)

#### Есть прошлые заказы

- Пользователь авторизован, есть история заказов, заказы отличаются от профиля
  - **Shop-Script:** Заполнил из профиля
  - **Prefill (будущий функционал):**
    - Может предложить альтернативные адреса доставки (из других заказов)
    - Предзаполнить последний способ доставки/оплаты (если настройка включена)
  - **Приоритет:**
    1. Данные из профиля (базовое поведение Shop-Script)
    2. Ручной выбор пользователя из предложенных адресов Prefill
    3. Последний заказ (если отличается от профиля)

#### После logout → login

- Пользователь разлогинился, затем снова залогинился
  - **Хранилище:** Временные данные анонимного пользователя уже не актуальны
  - **Поведение:** Загружаются данные профиля и история заказов авторизованного пользователя
  - **Prefill:** Работает по логике авторизованного пользователя

#### Секция Регион авторизованного пользователя

- **Shop-Script сам запоминает:** Последний выбранный регион для авторизованного пользователя
- **Cityselect:** Может переопределить секцию Регион, если куки действуют и отличаются
- **Prefill:** Не трогает секцию Регион, если она уже заполнена Shop-Script или Cityselect

## Интеграция с плагином CitySelect

**Логика работы CitySelect:**

- Предзаполняет секцию Регион только один раз при первом заходе пользователя (автоопределение по IP или ручной выбор)
- После оформления заказа повторно НЕ предзаполняет секцию Регион, даже если хранилище очищено
- Для авторизованных пользователей Shop-Script сам предзаполняет регион из профиля контакта, а оно туда сохраняется после первого заказа

**Интеграция Prefill с CitySelect:**

- При предзаполнении данных из последнего заказа Prefill устанавливает куки `cityselect__country`, `cityselect__region`, `cityselect__city`, `cityselect__zip`
- CitySelect подхватывает эти куки и использует их как источник данных для секции Регион
- Интеграция защищена кукой `prefill_cityselect` от повторного выполнения
