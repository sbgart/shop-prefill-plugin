class PrefillFrontendController{constructor(e){this.pluginID=e.pluginID,this.appUrl=e.appUrl,this.isDebug=e.isDebug,this.addParamsChoiceDialogListeners(),this.addOrderFormEventListener(),this.addConsentCheckboxListener(),this.log("PrefillFrontendController initialized.")}getDialog(e){let t=document.getElementById(e);return t||((t=document.createElement("dialog")).id=e,t.className="prefill-dialog",(e=document.createElement("span")).className="prefill-dialog__close-button",t.prepend(e),this.attachDialogCloseHandler(t,e),(e=document.createElement("div")).className="prefill-dialog__content",t.appendChild(e),document.body.appendChild(t)),t}async showDialog(e,t){var e=this.getDialog(e),o=e.querySelector(".prefill-dialog__content");if("function"!=typeof e.showModal)throw new Error("Метод showDialog не поддерживается этим браузером.");if(e.showModal(),t&&"function"==typeof t.then){o.innerHTML='<div class="prefill-dialog__loading">Готовим контент...</div>';try{t=await t}catch(e){t='<div class="prefill-dialog__error">Ошибка получения контента, попробуйте позже.</div>'}}return o.innerHTML=t,e}async fetchView(e,t={}){var o,a,n=new URLSearchParams;for([o,a]of Object.entries(t))n.append(o,a);t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()});if(t.ok)return t.text();throw new Error("Что-то пошло не так.")}attachDialogCloseHandler(t,e){t.addEventListener("click",e=>{e.target===t&&t.close()}),e.addEventListener("click",()=>{t.close()})}log(e,t="log"){var o;this.isDebug&&("function"==typeof console[t]&&console[t](`[${this.pluginID}] `+e),e="[frontend] "+e,(o=new FormData).append("message",e),o.append("type",t),e=""+this.appUrl+this.pluginID+"/logs",fetch(e,{method:"POST",body:o}))}async displayParamsChoiceDialog(){var e=this.fetchView(this.appUrl+"prefill/params-choice");await this.showDialog("prefill-params-choice-dialog",e)}addParamsChoiceDialogListeners(){var e=document.getElementById("js-order-form");e&&e.addEventListener("click",async e=>{if(e.target.classList.contains("display-params-choice-dialog")){e.preventDefault();try{await this.displayParamsChoiceDialog()}catch(e){this.log(e.message,"error")}}})}renderParamsChoiceLink(){var e,t,o=document.querySelector("#wa-step-region-section .wa-section-header");o?(e="params-choice-link",(t=document.getElementById(e))?this.log("Link already exists","info"):((t=document.createElement("a")).id=e,t.className="wa-tooltip bottom",t.textContent="Мои адреса",t.href="javascript:void(0);",t.setAttribute("data-title","Мои адреса на основе прошлых заказов"),t.onclick=async e=>{e.preventDefault();try{await this.displayParamsChoiceDialog()}catch(e){this.log(e.message,"error")}},o.appendChild(t),this.log("Link has been successfully added","info"))):this.log("Section header not found","error")}addOrderFormEventListener(){const t=this;$(document).on("wa_order_form_ready",function(e){t.renderParamsChoiceLink(),t.log("Order form ready, try render link")}),$(document).on("wa_order_form_region_changed",function(){t.renderParamsChoiceLink(),t.log("Order form region changed, try render link")}),$(document).on("wa_order_form_details_changed",function(){t.renderParamsChoiceLink(),t.log("Order form region changed, try render link")})}addConsentCheckboxListener(){const o=this;$(document).on("change",".js-prefill-consent-checkbox",function(){const t=$(this).is(":checked")?"grant":"revoke";$.post(o.appUrl+o.pluginID+"/consent",{action:t}).done(function(e){o.log("Consent "+t+": "+(e.data?.message||"ok"))}).fail(function(){o.log("Failed to update consent","error")})})}}