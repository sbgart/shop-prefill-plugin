class PrefillFrontendController{constructor(e){this.pluginID=e.pluginID,this.appUrl=e.appUrl,this.isDebug=e.isDebug,this.addParamsChoiceDialogListeners(),this.addOrderFormEventListener(),this.addConsentCheckboxListener(),this.log("PrefillFrontendController initialized.")}getDialog(e){let t=document.getElementById(e);if(!t){t=document.createElement("dialog"),t.id=e,t.className="prefill-dialog";const o=document.createElement("span");o.className="prefill-dialog__close-button",t.prepend(o),this.attachDialogCloseHandler(t,o);const n=document.createElement("div");n.className="prefill-dialog__content",t.appendChild(n),document.body.appendChild(t)}return t}async showDialog(e,t){const o=this.getDialog(e),n=o.querySelector(".prefill-dialog__content");if("function"!=typeof o.showModal)throw new Error("Метод showDialog не поддерживается этим браузером.");if(o.showModal(),t&&"function"==typeof t.then){n.innerHTML='<div class="prefill-dialog__loading">Готовим контент...</div>';try{t=await t}catch(e){t='<div class="prefill-dialog__error">Ошибка получения контента, попробуйте позже.</div>'}}return n.innerHTML=t,o}async fetchView(e,t={}){const o=new URLSearchParams;for(const[e,n]of Object.entries(t))o.append(e,n);const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o.toString()});if(!n.ok)throw new Error("Что-то пошло не так.");return await n.text()}attachDialogCloseHandler(e,t){e.addEventListener("click",t=>{t.target===e&&e.close()}),t.addEventListener("click",()=>{e.close()})}log(e,t="log"){if(!this.isDebug)return;"function"==typeof console[t]&&console[t](`[${this.pluginID}] ${e}`),e=`[frontend] ${e}`;let o=new FormData;o.append("message",e),o.append("type",t);const n=`${this.appUrl}${this.pluginID}/logs`;fetch(n,{method:"POST",body:o})}async displayParamsChoiceDialog(){const e=this.fetchView(`${this.appUrl}prefill/params-choice`);await this.showDialog("prefill-params-choice-dialog",e)}addParamsChoiceDialogListeners(){const e=document.getElementById("js-order-form");e&&e.addEventListener("click",async e=>{if(e.target.classList.contains("display-params-choice-dialog")){e.preventDefault();try{await this.displayParamsChoiceDialog()}catch(e){this.log(e.message,"error")}}})}renderParamsChoiceLink(){const e=document.querySelector("#wa-step-region-section .wa-section-header");if(!e)return void this.log("Section header not found","error");const t="params-choice-link";let o=document.getElementById(t);o?this.log("Link already exists","info"):(o=document.createElement("a"),o.id=t,o.className="wa-tooltip bottom",o.textContent="Мои адреса",o.href="javascript:void(0);",o.setAttribute("data-title","Мои адреса на основе прошлых заказов"),o.onclick=async e=>{e.preventDefault();try{await this.displayParamsChoiceDialog()}catch(e){this.log(e.message,"error")}},e.appendChild(o),this.log("Link has been successfully added","info"))}addOrderFormEventListener(){const e=this;$(document).on("wa_order_form_ready",function(t){e.renderParamsChoiceLink(),e.log("Order form ready, try render link")}),$(document).on("wa_order_form_region_changed",function(){e.renderParamsChoiceLink(),e.log("Order form region changed, try render link")}),$(document).on("wa_order_form_details_changed",function(){e.renderParamsChoiceLink(),e.log("Order form region changed, try render link")})}addConsentCheckboxListener(){const e=this;$(document).on("click",".js-prefill-consent-checkbox",function(t){t.preventDefault(),t.stopPropagation();const o=$(this);o.prop("checked",!o.prop("checked"));const n=o.is(":checked"),i=n?"grant":"revoke";return $.post(e.appUrl+e.pluginID+"/consent",{action:i}).done(function(t){e.log("Consent "+i+": "+(t?.data?.message||t?.message||"ok"))}).fail(function(){e.log("Failed to update consent","error"),o.prop("checked",!n)}),!1})}}